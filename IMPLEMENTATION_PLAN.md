# Implementation Plan — Vibe on Rails V2

Generated: 2026-02-05
Branch: feat/v2
Specs: ai-workflow/specs/v2.md

## Overview

VoR V2 transforms the framework from a development tool into an autonomous business operating system. 17 new packages across 5 families (Core, Infra, Ops, Sites, Companion) plus major additions to existing packages. Each phase is independently shippable and valuable.

## Architecture Decisions

- **AI SDK**: Thin SDK with capabilities map. chat() + generateStructured() only. embed() deferred to V2.x (YAGNI)
- **Sites SSG**: Astro deep wrap (Starlight pattern), user never sees astro.config, eject for power users
- **Content storage**: Filesystem + build-time-only SQLite index (CLI/build only, not runtime, serverless-safe)
- **Analytics**: Server-side default + opt-in first-party client script (<1KB)
- **Feature flags**: JSON definitions in git + runtime Redis overrides
- **Finance**: Reporting/aggregation layer with RevenueSource/CostSource interfaces (not Stripe-only)
- **Heuristics**: Mutable, git-tracked, git hash recorded in generated content
- **Support chat**: Simple AI + SSE with polling fallback + ticket escalation
- **Companion**: OpenClaw skills package with version pinning + compat check
- **Testing**: HTTP fixture recording for external APIs, <5min CI target
- **Package naming**: No ops- prefix on published names (@vibeonrails/marketing not @vibeonrails/marketing)
- **Module tracking**: .vibe/modules.json manifest with checksums for safe vibe remove
- **Frontmatter**: Enforce in build (fail), suggest in dev (warn)
- **Content index**: Build-time/CLI only, never runtime. No SQLite in production
- **.plan/ directory**: Project-scoped (one per root, not per-package)

### DX Decisions (Round 3)

- **First 5 minutes**: `vibe dev` detects missing DATABASE_URL, prints 3 options (Neon free tier / Docker / paste URL), waits and re-checks. No crash, no stack trace.
- **Error catalog**: Every error is a structured object in `packages/core/src/errors/catalog.ts`. Error code (VOR_XXX_NNN), message, location, fix, auto_fixable flag, docs link. No ad-hoc throw new Error().
- **Single config file**: `vibe.config.ts` is the ONLY config file. Security, sites, flags, analytics, modules — all sections of one typed file with autocomplete. Individual config files eliminated.
- **Dev server**: `vibe dev` starts API + web only. Sites start lazily on first request to their path. Single Vite instance in middleware mode. Target <3s boot.
- **SKILL.md auto-regen**: File watcher in dev mode auto-regenerates SKILL.md from code exports. Header `<!-- Auto-generated by VoR -->` marks auto-gen files. Manual edits respected (missing header = skip).
- **CLI runner**: `pnpm exec vibe` supported. Package.json scripts as primary pattern (`pnpm dev`, `pnpm build`). Global install option: `npm i -g @vibeonrails/cli` → bare `vibe` command.
- **Connect flow**: Local server approach (gh auth login pattern) with device code flow fallback for headless environments.
- **CLI output modes**: `VIBE_OUTPUT` env var: `human` (default, colors/spinners), `json` (structured, for AI), `ci` (no colors). Every command supports `--json` override. Consistent envelope: `{ command, success, data, warnings, next_steps }`.
- **No eject**: Override via config, or `vibe remove`. No eject command anywhere.
- **HMR matrix**: .ts → hot reload (instant), React → Vite HMR, Drizzle schema → detect change + suggest `vibe db migrate` (Django-style), content/\*.md → incremental rebuild, vibe.config.ts → full restart with warning.

### AI Agent Experience Decisions (Round 4A)

- **Project manifest**: Auto-generated `.vibe/project.json` on every `vibe dev` startup and after `vibe add/remove`. Contains: installed modules, available modules, routes, config, connections, content counts, available commands. One read = full context for any AI agent.
- **Structured errors for AI**: Every error outputs both human-readable AND machine-parseable JSON (via VIBE_OUTPUT=json). Includes `auto_fixable` flag so AI knows what it can fix without asking.
- **VIBE_OUTPUT=json global**: AI agents set this once, every command outputs structured JSON with `{ command, success, data, warnings, next_steps }` envelope. `next_steps` tells AI what to do next.
- **Deterministic file paths**: File paths are computable from intent. Module "order" → `src/modules/order/order.service.ts`. Heuristic hook "pain" → `content/marketing/heuristics/hooks/pain.md`. AI never needs to search.
- **VOR: comments in generated code**: `// VOR:` prefix comments in generated files as inline AI instructions. Only in generated code (Level 2), never in framework or user code.
- **Command registry**: `vibe commands --json` outputs full command tree with args, flags, prerequisites, examples. Also in `.vibe/project.json` under `commands` key.
- **Auto-regenerated SKILL.md**: Extracts exports, types, routes from actual code. Runs on file save (debounced 500ms) and on build. Always accurate, zero manual maintenance.

### Performance Targets (Round 4B)

- **Cold start**: `vibe dev` target <3s. Lazy DB/Redis connections, parallel init, skip uninstalled modules, tsx/esbuild for dev.
- **Build time**: `vibe build` target <30s. Parallel site builds, incremental builds (only changed content), image optimization cache (.vibe/image-cache/), esbuild for compilation + tsc for type checking in parallel.
- **API latency**: P99 <50ms for CRUD. Middleware chain <2ms, DB query budget <10ms simple / <30ms joins, Redis for hot paths. Dev mode per-request timing breakdown.
- **Bundle size**: <50KB gzipped base framework. Tree-shaking, lazy-loaded chat widget (<15KB) and search (<12KB), analytics client <1KB, no heavy deps (no moment/lodash).
- **SSG build**: <10s for 500 pages. Markdown parse cache, image cache, incremental Astro builds, parallel page generation.
- **Content index**: Full reindex <2s for 500 files, incremental <100ms. Streaming frontmatter parsing, batch SQLite writes, parallel file reads.
- **Dev memory**: <256MB RSS. Single Vite instance (middleware mode), lazy site servers, LRU content cache (100 entries), consolidated file watcher, WAL-mode SQLite.

### Observability & Debugging Decisions (Round 5)

- **Structured logging**: All logs are structured JSON (pino). Every log includes request_id, timestamp, level, module, message, and context. Human-readable in dev (pino-pretty), JSON in production. Logs go to stdout (12-factor).
- **Request tracing**: Every HTTP request gets a unique `x-request-id` header. This ID propagates through DB queries, external API calls, queue jobs, and AI SDK calls. Full request lifecycle traceable from one ID.
- **Dev query analyzer**: Dev mode logs every DB query with duration. Warns >100ms, suggests CREATE INDEX with exact statement. Detects N+1 patterns (same query executed >3x in one request). Zero overhead in production.
- **OAuth debugging**: `vibe connections status` shows token expiry, last refresh time, last error. Failed refreshes logged with full context (provider, error code, response body). Auto-retry with exponential backoff.
- **AI call logging**: Every AI SDK call logged with: prompt tokens, completion tokens, duration, model, provider, cost estimate. In dev, full prompt/response logged to `.vibe/ai-logs/`. In production, only metadata.
- **Production error context**: Every error in production includes: error code (catalog), request_id, user_id (if authenticated), stack trace, and auto_fixable hint. Errors are batched and reportable via `vibe errors --last 24h`.

### Deployment & Operations Decisions (Round 5)

- **One-command deploy**: `vibe deploy` auto-detects platform (Railway via RAILWAY_TOKEN, Fly.io via FLY_ACCESS_TOKEN, Docker via Dockerfile). Platform-specific optimizations applied automatically.
- **Migration safety**: Migrations auto-run during deploy ONLY if they are additive (add column, add table, add index). Destructive migrations (drop column, rename) require explicit `--destructive` flag. Rollback generates a down migration automatically.
- **Zero-downtime via flags**: Deploy code with new feature behind a feature flag (disabled). Verify health. Enable flag via `vibe flags toggle`. If broken, disable flag instantly. No rollback needed.
- **Health check gate**: Deploy process waits for `/health` to return 200 before routing traffic. Configurable timeout (default 30s). If health fails, deploy aborts and previous version stays live.
- **Env validation pre-deploy**: `vibe build` validates all required env vars exist and are valid BEFORE building. Missing vars fail the build with the exact var name and where to set it. No deploying broken configs.
- **Static/API split deploy**: Sites (SSG output) deploy to CDN independently from the API server. `vibe deploy --sites-only` pushes static files to CDN. `vibe deploy --api-only` deploys the server. Full deploy does both.

### Data Migration & Schema Evolution Decisions (Round 5)

- **Auto-generated migrations**: When Drizzle schema changes, `vibe db migrate create` auto-generates the SQL migration by diffing current schema vs database. Shows the SQL and asks for confirmation before writing the migration file.
- **Dry-run migrations**: `vibe db migrate --dry-run` shows exactly what SQL will run without executing it. Shows affected row counts for data migrations. Required step in CI before deploy.
- **Reversible migrations**: Every migration file has both `up()` and `down()`. Auto-generated migrations include the reverse operation. `vibe db rollback` runs the last migration's `down()`. Irreversible operations (data deletion) are flagged with warnings.
- **Migration testing in CI**: CI runs `up()` then `down()` then `up()` again for every migration. Verifies round-trip safety. Catches migrations that can't be rolled back.
- **Long-running migration support**: Migrations that touch >10K rows are flagged as long-running. These run as background jobs via BullMQ, not blocking the deploy process. Status trackable via `vibe db migrate status`.
- **Per-environment seeds**: `vibe db seed` reads from `database/seeds/{env}.ts`. Dev seeds create rich fake data (50 users, 200 posts). Staging seeds create minimal data. Production seeds create only system records (admin user, default config).

### Ecosystem & Extensibility Decisions (Round 5)

- **Custom integrations**: Users create integrations following the `defineIntegration()` pattern. Place in `src/integrations/my-service.ts`. Auto-discovered by the framework. Gets retry, rate limiting, health checking for free.
- **Custom CLI plugins**: Users create CLI commands in `src/commands/my-command.ts` using `defineCommand()`. Auto-registered by `vibe` CLI. Gets output formatting (VIBE_OUTPUT), error catalog, and --json support for free.
- **Community modules**: `vibe modules publish` packages a module for npm. `vibe modules list --community` discovers community modules. Standard package structure with SKILL.md enables AI agents to use any community module.

### Testing DX Decisions (Round 5)

- **Test factories**: `packages/test-utils/` ships factory helpers: `createUser()`, `createPost()`, `createOrder()` etc. Each factory generates realistic fake data with overrides. Factories auto-detect installed modules and generate appropriate data.
- **Transaction isolation**: Every integration test runs inside a database transaction that rolls back after the test. No test data leaks between tests. No database cleanup needed. Fast.
- **Fixture recording CLI**: `vibe test record <test-file>` runs the test with `LIVE_API=true`, records all HTTP interactions, saves to `__tests__/fixtures/`. Replay in CI. Re-record when API contracts change.
- **CLI output snapshot tests**: Test CLI commands by capturing their JSON output and comparing against snapshots. Detects unintended output changes. Works for all 3 output modes (human, json, ci).
- **Per-package coverage**: `vibe test --coverage` reports coverage per package. Fails build if any package drops below 80%. Shows which files need tests. Coverage badge in each package's README.

### WOW Factor Decisions (Round 6)

**Zero-to-Revenue Magic:**

- **60-second payments**: `npx create-vibe my-saas` with SaaS template ships with a working Stripe checkout page. User adds STRIPE_SECRET_KEY to .env, runs `vibe dev`, visits `/pricing` — working payment flow. Subscription management, customer portal, webhook handling — all pre-wired. Zero code for basic payments.
- **x402 pay-per-API-call**: Built-in x402 HTTP payment protocol. User marks any API route as paid: `paidProcedure.price('$0.01')`. Clients send payment in the HTTP header. Stablecoin (USDC) settlement. The user's API earns money from the first request. Companion gets a skill to monitor x402 revenue.
- **Pricing page component**: `<PricingTable />` component reads plans from `content/pricing/plans.md`. AI generates the pricing page from a one-sentence product description. Stripe checkout pre-connected to each plan button.
- **Revenue from minute one**: The SaaS template includes a pre-built onboarding flow: landing page → signup → select plan → pay → dashboard. Every step works out of the box. The user's first customer can pay before the user writes a single line of business logic.
- **Invoice + tax handling**: Finance module generates professional PDF invoices from markdown templates. Tax calculation via Stripe Tax (already integrated). `vibe finance invoice create` works immediately.

**Companion Setup Experience:**

- **One-command OpenClaw**: `vibe companion setup` detects if user has OpenClaw. If not, offers: (A) Deploy OpenClaw to Railway with one click (Railway template), (B) Docker compose locally, (C) Connect to existing instance. Option A provisions a VPS with OpenClaw + VoR skills in ~60 seconds.
- **Companion first impression**: After setup, the companion introduces itself in Discord: "Hey! I'm [name]. I can run any vibe command, generate content, check your MRR, and triage support requests. Try: 'what's my MRR?' or 'generate a tweet about [topic]'."
- **Multi-project companion**: One OpenClaw instance serves multiple VoR projects. Each project installs its own skills. The companion knows which project you're talking about based on the Discord channel or explicit context.
- **Companion revenue monitoring**: Companion skill that reports daily revenue, alerts on churn spikes, celebrates new customers. "You just hit $1K MRR!" with confetti emoji.
- **Companion-as-team-lead**: Companion can be configured to run periodic tasks: weekly finance report every Monday, content generation every weekday, support summary every Friday. All configurable via `content/brand/agent.md`.

**Time Travel & Undo:**

- **`vibe undo`**: Reverts the last CLI operation using the manifest. `vibe add marketing` → `vibe undo` removes it. `vibe generate module order` → `vibe undo` deletes the files. Undo stack stores last 10 operations in `.vibe/undo-stack.json`.
- **Content version history**: `vibe content history <file>` shows git log for any content file with diffs. `vibe content restore <file> <commit>` restores a previous version. The AI can compare versions: "This hook performed 2x better before the last edit."
- **Database snapshots**: `vibe db snapshot create <name>` creates a named snapshot of the current database state. `vibe db snapshot restore <name>` restores it. Instant rollback during development. Snapshots stored in `.vibe/snapshots/`.
- **Config diff**: `vibe config diff` shows what changed in vibe.config.ts since last deploy. Highlights security-relevant changes. Prevents accidental config changes from reaching production.
- **Migration rollback**: `vibe db rollback` reverts the last migration. `vibe db rollback --to <version>` reverts to a specific version. Always shows the SQL before executing. Reversible by design.

**Show Don't Tell (Live Dashboards):**

- **`vibe status` command**: One-command business dashboard. Shows: MRR, active users, page views (24h), open support tickets, content pipeline (drafts/posted), API health, build status, deployment version. All from one command. Beautiful terminal output in human mode, structured JSON in AI mode.
- **Dev welcome page**: `vibe dev` serves a welcome page at `/` (before user adds routes) showing: project name, installed modules, quick links to each site, API explorer link, Drizzle Studio link, health status. The first thing the user sees works.
- **Admin panel auto-generation**: Admin panel at `/admin` auto-generates CRUD views for every database table. No code needed. Tables are discovered from Drizzle schema. Columns are typed. Relations are linked. Search, filter, sort — all automatic.
- **Build progress reporting**: `vibe build` shows a real-time progress view: `[1/5] TypeScript... done 3.2s [2/5] Frontend... done 6.1s [3/5] Sites (parallel)... blog done 2.1s, help done 1.8s...`. Each step shows timing. Slow steps highlighted.
- **`vibe report` weekly AI summary**: AI-generated weekly business report. Reads: analytics (signups, pageviews), finance (MRR, churn), support (tickets, satisfaction), marketing (posts, engagement). Generates a 1-page markdown summary. Companion posts it to #general every Monday.

**AI-Native Superpowers:**

- **`vibe ask`**: Natural language interface to the entire framework. "How do I add a payment flow?" → reads SKILL.md files + project.json + docs → answers with the exact steps for THIS project. Context-aware, not generic docs search.
- **`vibe fix`**: Scans project for all errors (type errors, missing env vars, broken configs). Auto-fixes everything marked `auto_fixable` in the error catalog. Reports what was fixed and what needs human decision. AI agent's best friend.
- **AI module generation**: `vibe generate module order --describe "handles e-commerce orders with Stripe checkout, inventory tracking, and email confirmations"` → AI generates full module: types (Zod schemas), service (business logic), controller (tRPC routes), tests (unit + integration). From one sentence.
- **One-sentence landing page**: User writes `description: "AI-powered project management for remote teams"` in vibe.config.ts. `vibe sites build` generates a complete landing page: hero section, features grid, pricing table, CTA — all from that one sentence + product heuristics. The AI reads the branding heuristic for voice and the product heuristic for features.
- **Predictive error prevention**: Dev mode analyzes code as you write (via file watcher). Detects: missing Zod validation on user input, unhandled error cases, missing auth on new routes, SQL injection patterns. Warns BEFORE the code runs. Like a real-time security + correctness linter powered by the error catalog.

---

## Phase 1: Foundation (Core Additions + AI SDK)

Everything else depends on this phase. AI SDK is the backbone for all Ops modules. Core additions (OAuth store, integrations SDK, webhooks, API keys) are required by marketing, sales, support, and finance.

### Project 1.1: AI SDK (@vibeonrails/ai)

#### task0001: Create AI SDK package scaffolding

File: `packages/ai/package.json`
Description: Initialize the @vibeonrails/ai package with TypeScript config, Vitest setup, barrel exports, and SKILL.md.
Status: done

#### task0002: AI SDK provider types and interfaces

File: `packages/ai/src/types.ts`
Description: Define AIProvider interface, AIConfig, ChatMessage, StructuredOutput, CapabilitiesMap types. Define provider.supports() capability checking. No embed() in V2 (deferred to V2.x with pgvector).
Status: done
Depends: task0001

#### task0003: AI SDK provider types tests

File: `packages/ai/src/types.test.ts`
Description: Write tests for type validation, capabilities map checking, config schema validation with Zod.
Status: done
Depends: task0002

#### task0004: Anthropic provider implementation

File: `packages/ai/src/providers/anthropic.ts`
Description: Implement AnthropicProvider: chat(), embed(), generateStructured(), capabilities map, retry logic, streaming.
Status: pending
Depends: task0002

#### task0005: Anthropic provider tests

File: `packages/ai/src/providers/anthropic.test.ts`
Description: Write tests with HTTP fixture recording for chat, embed, generateStructured. Test retry logic, error handling, streaming.
Status: pending
Depends: task0004

#### task0006: OpenAI provider implementation

File: `packages/ai/src/providers/openai.ts`
Description: Implement OpenAIProvider with same interface. Provider-specific capabilities (function calling format, vision).
Status: pending
Depends: task0002

#### task0007: OpenAI provider tests

File: `packages/ai/src/providers/openai.test.ts`
Description: Write tests with HTTP fixture recording.
Status: pending
Depends: task0006

#### task0008: Ollama provider implementation

File: `packages/ai/src/providers/ollama.ts`
Description: Implement OllamaProvider for local/open-source models. Reduced capabilities map.
Status: pending
Depends: task0002

#### task0009: Ollama provider tests

File: `packages/ai/src/providers/ollama.test.ts`
Description: Write tests with HTTP fixture recording.
Status: pending
Depends: task0008

#### task0010: AI SDK factory and config

File: `packages/ai/src/index.ts`
Description: Implement createAI() factory function, provider auto-detection from env vars, config validation, barrel exports.
Status: pending
Depends: task0004, task0006, task0008

#### task0011: AI SDK factory tests

File: `packages/ai/src/index.test.ts`
Description: Write tests for factory creation, provider switching, env var detection, error on missing config.
Status: pending
Depends: task0010

### Project 1.2: OAuth Token Store

#### task0012: OAuth token store types

File: `packages/core/src/security/oauth/types.ts`
Description: Define OAuthToken, EncryptedTokenStore, TokenRefreshConfig interfaces. Zod schemas for token validation.
Status: pending

#### task0013: OAuth token encryption implementation

File: `packages/core/src/security/oauth/encrypt.ts`
Description: Implement AES-256-GCM encryption/decryption for tokens using key derived from JWT_SECRET.
Status: pending
Depends: task0012

#### task0014: OAuth token encryption tests

File: `packages/core/src/security/oauth/encrypt.test.ts`
Description: Test encrypt/decrypt roundtrip, key derivation, tamper detection, different token formats.
Status: pending
Depends: task0013

#### task0015: OAuth file-based token store

File: `packages/core/src/security/oauth/store.ts`
Description: Implement FileTokenStore that reads/writes .vibe/credentials.json. Token CRUD, refresh flow, gitignore verification.
Status: pending
Depends: task0013

#### task0016: OAuth file-based token store tests

File: `packages/core/src/security/oauth/store.test.ts`
Description: Test store CRUD, file persistence, refresh flow, concurrent access, missing file handling.
Status: pending
Depends: task0015

#### task0017: OAuth barrel exports

File: `packages/core/src/security/oauth/index.ts`
Description: Export all OAuth types, encryption, and store from barrel. Update core package exports.
Status: pending
Depends: task0015

### Project 1.3: Integrations SDK

#### task0018: Integration SDK types

File: `packages/core/src/integrations/types.ts`
Description: Define IntegrationConfig, defineIntegration() signature, retry config, rate limit config, health check interface.
Status: pending

#### task0019: Integration SDK core implementation

File: `packages/core/src/integrations/sdk.ts`
Description: Implement defineIntegration() with automatic retry (exponential backoff), rate limiting awareness, error normalization, health checking.
Status: pending
Depends: task0018

#### task0020: Integration SDK tests

File: `packages/core/src/integrations/sdk.test.ts`
Description: Test retry logic, rate limit handling, error normalization, health check reporting.
Status: pending
Depends: task0019

#### task0021: Twitter integration

File: `packages/core/src/integrations/twitter.ts`
Description: Implement Twitter integration using defineIntegration(). OAuth flow, tweet posting, thread creation.
Status: pending
Depends: task0019, task0015

#### task0022: Twitter integration tests

File: `packages/core/src/integrations/twitter.test.ts`
Description: Test with HTTP fixture recording. OAuth flow, posting, error handling, rate limits.
Status: pending
Depends: task0021

#### task0023: Bluesky integration

File: `packages/core/src/integrations/bluesky.ts`
Description: Implement Bluesky integration using defineIntegration(). Auth, post creation.
Status: pending
Depends: task0019, task0015

#### task0024: Bluesky integration tests

File: `packages/core/src/integrations/bluesky.test.ts`
Description: Test with HTTP fixture recording.
Status: pending
Depends: task0023

#### task0025: Integrations barrel exports

File: `packages/core/src/integrations/index.ts`
Description: Export all integrations types, SDK, and shipped integrations. Update core package exports.
Status: pending
Depends: task0021, task0023

### Project 1.4: Inbound Webhooks

#### task0026: Webhook types and defineWebhook

File: `packages/core/src/webhooks/types.ts`
Description: Define WebhookConfig, defineWebhook() signature, signature verification interface.
Status: pending

#### task0027: Webhook handler implementation

File: `packages/core/src/webhooks/handler.ts`
Description: Implement defineWebhook() with signature verification (Stripe, GitHub), CSRF exclusion, event logging.
Status: pending
Depends: task0026

#### task0028: Webhook handler tests

File: `packages/core/src/webhooks/handler.test.ts`
Description: Test signature verification, CSRF bypass, event logging, invalid signature rejection.
Status: pending
Depends: task0027

#### task0029: Webhook barrel exports

File: `packages/core/src/webhooks/index.ts`
Description: Export webhook types and handler. Update core package exports.
Status: pending
Depends: task0027

### Project 1.5: API Key Management

#### task0030: API key types

File: `packages/core/src/api-keys/types.ts`
Description: Define APIKey, APIKeyConfig, key prefix format (vor_live_xxx, vor_test_xxx), rate limit per key.
Status: pending

#### task0031: API key service

File: `packages/core/src/api-keys/service.ts`
Description: Implement key generation, hashing (never store plain text), validation, usage tracking, revocation.
Status: pending
Depends: task0030

#### task0032: API key service tests

File: `packages/core/src/api-keys/service.test.ts`
Description: Test key generation, hash verification, prefix format, rate limiting, revocation.
Status: pending
Depends: task0031

#### task0033: API key middleware

File: `packages/core/src/api-keys/middleware.ts`
Description: Implement Hono middleware to authenticate requests by API key. Extract from header, validate, attach to context.
Status: pending
Depends: task0031

#### task0034: API key middleware tests

File: `packages/core/src/api-keys/middleware.test.ts`
Description: Test middleware authentication, missing key, invalid key, rate limited key, revoked key.
Status: pending
Depends: task0033

#### task0035: API key database migration

File: `packages/core/src/api-keys/schema.ts`
Description: Drizzle schema for api_keys table. Hashed key, prefix, user_id, rate_limit, usage_count, revoked_at.
Status: pending
Depends: task0030

#### task0036: API key barrel exports

File: `packages/core/src/api-keys/index.ts`
Description: Export all API key types, service, middleware, schema. Update core package exports.
Status: pending
Depends: task0033, task0035

### Project 1.6: Infra Additions (Rate Limiting + Feature Flags)

#### task0037: Rate limiting types

File: `packages/infra/src/rate-limit/types.ts`
Description: Define RateLimitConfig, sliding window interface, per-user and per-endpoint config.
Status: pending

#### task0038: Rate limiting implementation

File: `packages/infra/src/rate-limit/limiter.ts`
Description: Implement Redis-backed sliding window rate limiter. Standard headers (X-RateLimit-\*). Global and per-route.
Status: pending
Depends: task0037

#### task0039: Rate limiting tests

File: `packages/infra/src/rate-limit/limiter.test.ts`
Description: Test sliding window, header generation, per-user tracking, limit exceeded response.
Status: pending
Depends: task0038

#### task0040: Rate limiting middleware

File: `packages/infra/src/rate-limit/middleware.ts`
Description: Hono middleware for rate limiting. Configurable per-route. Default limits on auth endpoints.
Status: pending
Depends: task0038

#### task0041: Rate limiting middleware tests

File: `packages/infra/src/rate-limit/middleware.test.ts`
Description: Test middleware application, per-route config, default auth limits, bypass for whitelisted routes.
Status: pending
Depends: task0040

#### task0042: Feature flags types

File: `packages/infra/src/flags/types.ts`
Description: Define FlagDefinition, FlagConfig, FlagContext (userId for percentage rollouts), isEnabled signature.
Status: pending

#### task0043: Feature flags implementation

File: `packages/infra/src/flags/flags.ts`
Description: Implement two-layer system: JSON file definitions + optional Redis runtime overrides. isEnabled() checks Redis first, falls back to JSON.
Status: pending
Depends: task0042

#### task0044: Feature flags tests

File: `packages/infra/src/flags/flags.test.ts`
Description: Test JSON-only mode, Redis override mode, percentage rollouts, missing flag handling.
Status: pending
Depends: task0043

#### task0045: Feature flags CLI command

File: `packages/infra/src/flags/cli.ts`
Description: Implement `npx vibe flags toggle`, `npx vibe flags list`, `npx vibe flags status` commands.
Status: pending
Depends: task0043

#### task0046: Feature flags CLI tests

File: `packages/infra/src/flags/cli.test.ts`
Description: Test CLI toggle, list, status commands.
Status: pending
Depends: task0045

#### task0047: Rate limiting and flags barrel exports

File: `packages/infra/src/rate-limit/index.ts`
Description: Export rate limiting and feature flags. Update infra package exports.
Status: pending
Depends: task0040, task0043

### Project 1.7: Error Catalog + Structured Errors

#### task0201: Error catalog types and registry

File: `packages/core/src/errors/catalog.ts`
Description: Define error catalog structure: error code (VOR_XXX_NNN), message template, detail, fix (command or instruction), auto_fixable flag, docs URL. Registry map of all framework errors. No ad-hoc throw new Error() allowed — all errors must be registered.
Status: pending

#### task0202: Error catalog tests

File: `packages/core/src/errors/catalog.test.ts`
Description: Test error lookup by code, message template interpolation, auto_fixable flag, docs URL generation. Validate no duplicate error codes.
Status: pending
Depends: task0201

#### task0203: AppError class using catalog

File: `packages/core/src/errors/app-error.ts`
Description: Refactor AppError to use the error catalog. Constructor takes error code + context params. Outputs human-readable (default) or structured JSON (VIBE_OUTPUT=json). Includes location, fix, auto_fixable.
Status: pending
Depends: task0201

#### task0204: AppError tests

File: `packages/core/src/errors/app-error.test.ts`
Description: Test AppError output in human mode and JSON mode. Test auto_fixable flag, location info, fix command rendering.
Status: pending
Depends: task0203

### Project 1.8: vibe.config.ts (Single Config File)

#### task0205: Config schema and types

File: `packages/core/src/config/schema.ts`
Description: Define Zod schema for vibe.config.ts: security (cors, rateLimit, csrf, session), sites (blog, help, etc.), flags (key-value), analytics (server, client), modules list. defineConfig() helper with full TypeScript autocomplete.
Status: pending

#### task0206: Config schema tests

File: `packages/core/src/config/schema.test.ts`
Description: Test config validation, defaults, partial overrides, type inference from defineConfig().
Status: pending
Depends: task0205

#### task0207: Config loader

File: `packages/core/src/config/loader.ts`
Description: Load and validate vibe.config.ts at startup. Merge with defaults. Export typed config object. Replace individual config files (security.ts, sites.ts, etc.) with sections of this one file.
Status: pending
Depends: task0205

#### task0208: Config loader tests

File: `packages/core/src/config/loader.test.ts`
Description: Test loading from file, default merging, validation errors with clear messages, missing file handling (use all defaults).
Status: pending
Depends: task0207

### Project 1.9: Project Manifest (.vibe/project.json)

#### task0209: Project manifest generator

File: `packages/core/src/manifest/generator.ts`
Description: Auto-generate .vibe/project.json from: vibe.config.ts, .vibe/modules.json, route scanning, connection status, content counts. Runs on vibe dev startup and after vibe add/remove.
Status: pending
Depends: task0207

#### task0210: Project manifest generator tests

File: `packages/core/src/manifest/generator.test.ts`
Description: Test manifest generation with various module combinations, route scanning, content counting.
Status: pending
Depends: task0209

#### task0211: Command registry

File: `packages/cli/src/commands/commands.ts`
Description: Implement `vibe commands --json` that outputs full command tree with args, flags, prerequisites, examples. Also populates the commands section of .vibe/project.json.
Status: pending
Depends: task0209

#### task0212: Command registry tests

File: `packages/cli/src/commands/commands.test.ts`
Description: Test command tree output, JSON format, prerequisite checking, example validation.
Status: pending
Depends: task0211

### Project 1.10: CLI Output System (VIBE_OUTPUT)

#### task0213: Output formatter

File: `packages/cli/src/output/formatter.ts`
Description: Implement output system respecting VIBE_OUTPUT env var: human (colors/spinners), json (structured envelope), ci (plain text). Consistent envelope: { command, success, data, warnings, next_steps }. Every CLI command uses this formatter.
Status: pending

#### task0214: Output formatter tests

File: `packages/cli/src/output/formatter.test.ts`
Description: Test all 3 output modes, envelope structure, --json override, next_steps population.
Status: pending
Depends: task0213

### Project 1.11: Environment Validation (First 5 Minutes)

#### task0215: Environment validator

File: `packages/core/src/env/validator.ts`
Description: Validate all env vars at startup before server starts. Missing DATABASE_URL: show 3 options (Neon/Docker/paste), wait for input, re-check. Missing optional vars: warn with setup instructions. JWT_SECRET too short: show fix command. Uses error catalog for all messages.
Status: pending
Depends: task0201, task0207

#### task0216: Environment validator tests

File: `packages/core/src/env/validator.test.ts`
Description: Test missing required vars, missing optional vars (warning only), invalid values, interactive prompt flow.
Status: pending
Depends: task0215

### Project 1.12: SKILL.md Auto-Regeneration

#### task0217: SKILL.md generator

File: `packages/cli/src/skillmd/generator.ts`
Description: Extract exports, function signatures, types, and routes from TypeScript source files. Generate SKILL.md with module description, available methods, input/output types, usage examples. Header: <!-- Auto-generated by VoR -->. Skip files with manual edits (missing header).
Status: pending

#### task0218: SKILL.md generator tests

File: `packages/cli/src/skillmd/generator.test.ts`
Description: Test extraction from sample modules, SKILL.md formatting, manual edit detection, debounced file watcher integration.
Status: pending
Depends: task0217

### Project 1.13: VOR: Comments in Generated Code

#### task0219: Code generator templates with VOR: comments

File: `packages/cli/src/generators/templates.ts`
Description: Update all generate module/component templates to include `// VOR:` inline comments guiding AI agents. Comments explain what to modify, what patterns to follow, what to leave alone. Only in Level 2 generated code.
Status: pending

#### task0220: Code generator template tests

File: `packages/cli/src/generators/templates.test.ts`
Description: Test that generated files contain VOR: comments, correct patterns, proper imports.
Status: pending
Depends: task0219

### Project 1.14: Connect Flow (OAuth)

#### task0221: OAuth connect server

File: `packages/cli/src/commands/connect-server.ts`
Description: Implement local HTTP server for OAuth callback (gh auth login pattern). Start temp server on random port, open browser with redirect_uri, capture token, encrypt and store, shut down. Device code flow fallback for headless environments.
Status: pending
Depends: task0015

#### task0222: OAuth connect server tests

File: `packages/cli/src/commands/connect-server.test.ts`
Description: Test local server lifecycle, callback handling, token storage, device code fallback detection.
Status: pending
Depends: task0221

### Project 1.15: Build-Time Content Index

#### task0048: Content index types

File: `packages/core/src/content/types.ts`
Description: Define ContentEntry, ContentIndex, IndexConfig, frontmatter schema types. SQLite schema definition.
Status: pending

#### task0049: Content index builder

File: `packages/core/src/content/indexer.ts`
Description: Implement build-time-only content indexer (CLI/build tool, never runtime server). Scan content directories, parse frontmatter, write to .vibe/content.db (SQLite). Incremental indexing via mtime comparison. No SQLite in production — serverless-safe.
Status: pending
Depends: task0048

#### task0050: Content index builder tests

File: `packages/core/src/content/indexer.test.ts`
Description: Test full index build, incremental update, frontmatter parsing, SQLite queries, temp directory fixtures.
Status: pending
Depends: task0049

#### task0051: Content index query API

File: `packages/core/src/content/query.ts`
Description: Implement query functions: listByType(), filterByTag(), searchByKeyword(), getByPath(). In-memory caching for hot content.
Status: pending
Depends: task0049

#### task0052: Content index query tests

File: `packages/core/src/content/query.test.ts`
Description: Test all query functions with fixture content. Test cache behavior, empty index, missing index rebuild.
Status: pending
Depends: task0051

#### task0053: Content index CLI command

File: `packages/core/src/content/cli.ts`
Description: Implement `npx vibe content reindex` command. Auto-reindex on file changes in dev mode.
Status: pending
Depends: task0049

#### task0054: Content index barrel exports

File: `packages/core/src/content/index.ts`
Description: Export content index types, indexer, query API. Update core package exports.
Status: pending
Depends: task0051, task0053

### Project 1.16: Analytics (Infra)

#### task0055: Analytics types

File: `packages/infra/src/analytics/types.ts`
Description: Define AnalyticsEvent, track() signature, AnalyticsConfig, client-side event types for opt-in script.
Status: pending

#### task0056: Server-side analytics implementation

File: `packages/infra/src/analytics/tracker.ts`
Description: Implement track(event, properties). Auto-track middleware for page views, API calls, auth events. Postgres storage.
Status: pending
Depends: task0055

#### task0057: Server-side analytics tests

File: `packages/infra/src/analytics/tracker.test.ts`
Description: Test event tracking, auto-track middleware, Postgres storage, event querying.
Status: pending
Depends: task0056

#### task0058: Analytics query engine

File: `packages/infra/src/analytics/query.ts`
Description: Implement natural language query via AI SDK. `npx vibe analytics query "signups this week"` translates to SQL.
Status: pending
Depends: task0056, task0010

#### task0059: Analytics query engine tests

File: `packages/infra/src/analytics/query.test.ts`
Description: Test query generation with fixture AI responses. Test SQL generation safety (no injection).
Status: pending
Depends: task0058

#### task0060: First-party client analytics script

File: `packages/web/src/analytics/client.ts`
Description: Lightweight (<1KB) client-side script. Sends events to /api/analytics. Tracks scroll depth, time on page, clicks, errors. No cookies.
Status: pending
Depends: task0055

#### task0061: Client analytics script tests

File: `packages/web/src/analytics/client.test.ts`
Description: Test event collection, batched sending, payload format, no cookie creation.
Status: pending
Depends: task0060

#### task0062: Analytics database migration

File: `packages/infra/src/analytics/schema.ts`
Description: Drizzle schema for analytics_events table. Event name, properties (JSONB), timestamp, session_id, page_url.
Status: pending
Depends: task0055

#### task0063: Analytics CLI commands

File: `packages/infra/src/analytics/cli.ts`
Description: Implement `npx vibe analytics query`, `npx vibe analytics events list`, `npx vibe analytics report`, `npx vibe analytics pageviews`.
Status: pending
Depends: task0058

#### task0064: Analytics barrel exports

File: `packages/infra/src/analytics/index.ts`
Description: Export analytics types, tracker, query engine, schema. Update infra package exports.
Status: pending
Depends: task0058, task0062

---

## Phase 2: Sites (SSG + Search + Web A11y)

Content publishing platform powered by Astro. All site packages, AI-powered search, and accessibility additions to @vibeonrails/web.

### Project 2.1: Web Accessibility Additions

#### task0065: SkipLink component

File: `packages/web/src/components/a11y/skip-link.tsx`
Description: Implement SkipLink component. Auto-included in PageLayout. Skip to main content.
Status: pending

#### task0066: SkipLink component tests

File: `packages/web/src/components/a11y/skip-link.test.tsx`
Description: Test skip link rendering, keyboard activation, focus management.
Status: pending
Depends: task0065

#### task0067: LiveRegion component

File: `packages/web/src/components/a11y/live-region.tsx`
Description: Implement LiveRegion for screen reader announcements of dynamic content.
Status: pending

#### task0068: LiveRegion component tests

File: `packages/web/src/components/a11y/live-region.test.tsx`
Description: Test aria-live attribute, polite/assertive modes, content updates.
Status: pending
Depends: task0067

#### task0069: FocusGuard component

File: `packages/web/src/components/a11y/focus-guard.tsx`
Description: Implement focus trapping for modals and dialogs. Escape to close.
Status: pending

#### task0070: FocusGuard component tests

File: `packages/web/src/components/a11y/focus-guard.test.tsx`
Description: Test focus trapping, escape key, tab cycling, return focus on close.
Status: pending
Depends: task0069

#### task0071: KeyboardShortcuts component

File: `packages/web/src/components/a11y/keyboard-shortcuts.tsx`
Description: Implement Cmd+K command palette. Keyboard shortcut registration system.
Status: pending

#### task0072: KeyboardShortcuts component tests

File: `packages/web/src/components/a11y/keyboard-shortcuts.test.tsx`
Description: Test shortcut registration, Cmd+K activation, conflict detection.
Status: pending
Depends: task0071

#### task0073: Accessibility CSS

File: `packages/web/src/styles/a11y.css`
Description: .sr-only class, focus-visible styles, reduced-motion media query, focus ring styles.
Status: pending

#### task0074: A11y barrel exports

File: `packages/web/src/components/a11y/index.ts`
Description: Export all a11y components. Update web package exports.
Status: pending
Depends: task0065, task0067, task0069, task0071, task0073

### Project 2.2: Search (@vibeonrails/search)

#### task0075: Search package scaffolding

File: `packages/search/package.json`
Description: Initialize @vibeonrails/search with TypeScript config, Vitest, barrel exports, SKILL.md.
Status: pending

#### task0076: Search index types and schema

File: `packages/search/src/types.ts`
Description: Define SearchIndex, SearchResult, SearchConfig types. Drizzle schema for search_index table with tsvector.
Status: pending
Depends: task0075

#### task0077: Build-time search indexer

File: `packages/search/src/indexer.ts`
Description: Scan all content sources (docs, blog, help, changelog), extract title/headings/snippets/URL, insert into Postgres with tsvector.
Status: pending
Depends: task0076

#### task0078: Search indexer tests

File: `packages/search/src/indexer.test.ts`
Description: Test content scanning, tsvector generation, incremental indexing, scope tagging.
Status: pending
Depends: task0077

#### task0079: Search query engine

File: `packages/search/src/query.ts`
Description: Parallel: Postgres full-text search (top 10 by relevance) + AI synthesis (question + snippets = answer). Scoped by site.
Status: pending
Depends: task0077, task0010

#### task0080: Search query engine tests

File: `packages/search/src/query.test.ts`
Description: Test FTS ranking, AI synthesis with fixtures, scope filtering, empty results handling.
Status: pending
Depends: task0079

#### task0081: Search reindex CLI

File: `packages/search/src/cli.ts`
Description: Implement `npx vibe search reindex`, `npx vibe search query`, `npx vibe search stats`.
Status: pending
Depends: task0079

#### task0082: UnifiedSearch React component

File: `packages/web/src/components/search/unified-search.tsx`
Description: Search component for all Sites. AI answer at top, traditional results below. Site scope selector.
Status: pending
Depends: task0079

#### task0083: UnifiedSearch component tests

File: `packages/web/src/components/search/unified-search.test.tsx`
Description: Test rendering, scope selection, result display, AI answer display, loading states.
Status: pending
Depends: task0082

#### task0084: Search barrel exports

File: `packages/search/src/index.ts`
Description: Export search types, indexer, query engine. Update package exports.
Status: pending
Depends: task0079, task0081

### Project 2.3: Site Blog (@vibeonrails/site-blog)

#### task0085: Blog package scaffolding

File: `packages/sites/blog/package.json`
Description: Initialize @vibeonrails/site-blog as an Astro integration. TypeScript config, SKILL.md.
Status: pending

#### task0086: Blog Astro integration (deep wrap)

File: `packages/sites/blog/src/integration.ts`
Description: Implement Astro deep wrap (Starlight pattern) that reads content/blog/ markdown, applies VoR CSS, generates pages. User never sees astro.config. Frontmatter validation: warn in dev, fail in build.
Status: pending
Depends: task0085

#### task0087: Blog integration tests

File: `packages/sites/blog/src/integration.test.ts`
Description: Test page generation from fixture markdown, frontmatter parsing, tag filtering, chronological order.
Status: pending
Depends: task0086

#### task0088: Blog RSS and sitemap

File: `packages/sites/blog/src/feeds.ts`
Description: Generate RSS feed and sitemap entries from blog content.
Status: pending
Depends: task0086

#### task0089: Blog feeds tests

File: `packages/sites/blog/src/feeds.test.ts`
Description: Test RSS XML format, sitemap entries, date handling, URL generation.
Status: pending
Depends: task0088

#### task0090: Blog barrel exports

File: `packages/sites/blog/src/index.ts`
Description: Export blog integration and configuration types.
Status: pending
Depends: task0086, task0088

### Project 2.4: Site Help (@vibeonrails/site-help)

#### task0091: Help center package scaffolding

File: `packages/sites/help/package.json`
Description: Initialize @vibeonrails/site-help as Astro integration. SKILL.md.
Status: pending

#### task0092: Help center Astro integration

File: `packages/sites/help/src/integration.ts`
Description: Read content/help/ organized by category folders. Category navigation, search integration.
Status: pending
Depends: task0091

#### task0093: Help center tests

File: `packages/sites/help/src/integration.test.ts`
Description: Test category navigation, page generation, "Was this helpful?" feedback integration.
Status: pending
Depends: task0092

#### task0094: Help center barrel exports

File: `packages/sites/help/src/index.ts`
Description: Export help center integration and types.
Status: pending
Depends: task0092

### Project 2.5: Site Landing (@vibeonrails/site-landing)

#### task0095: Landing pages package scaffolding

File: `packages/sites/landing/package.json`
Description: Initialize @vibeonrails/site-landing as Astro integration. SKILL.md.
Status: pending

#### task0096: Landing pages Astro integration

File: `packages/sites/landing/src/integration.ts`
Description: Read content/pages/ markdown. Custom layouts via frontmatter. Analytics campaign attribution.
Status: pending
Depends: task0095

#### task0097: Landing pages tests

File: `packages/sites/landing/src/integration.test.ts`
Description: Test page generation, custom layouts, OG meta from frontmatter.
Status: pending
Depends: task0096

#### task0098: Landing pages barrel exports

File: `packages/sites/landing/src/index.ts`
Description: Export landing integration and types.
Status: pending
Depends: task0096

### Project 2.6: Site Changelog (@vibeonrails/site-changelog)

#### task0099: Changelog package scaffolding

File: `packages/sites/changelog/package.json`
Description: Initialize @vibeonrails/site-changelog as Astro integration. SKILL.md.
Status: pending

#### task0100: Changelog Astro integration

File: `packages/sites/changelog/src/integration.ts`
Description: Read content/changelog/ markdown. Version anchors, chronological listing, RSS feed.
Status: pending
Depends: task0099

#### task0101: Changelog tests

File: `packages/sites/changelog/src/integration.test.ts`
Description: Test version ordering, RSS generation, frontmatter parsing (version, date, type).
Status: pending
Depends: task0100

#### task0102: Changelog barrel exports

File: `packages/sites/changelog/src/index.ts`
Description: Export changelog integration and types.
Status: pending
Depends: task0100

### Project 2.7: Site Status (@vibeonrails/site-status)

#### task0103: Status page package scaffolding

File: `packages/sites/status/package.json`
Description: Initialize @vibeonrails/site-status as Astro integration. SKILL.md.
Status: pending

#### task0104: Status page integration

File: `packages/sites/status/src/integration.ts`
Description: Poll /health endpoint, display health checks. Incident log from content/incidents/. Auto-refresh. Public page.
Status: pending
Depends: task0103

#### task0105: Status page tests

File: `packages/sites/status/src/integration.test.ts`
Description: Test health check display, incident rendering, auto-refresh behavior.
Status: pending
Depends: task0104

#### task0106: Status page barrel exports

File: `packages/sites/status/src/index.ts`
Description: Export status page integration and types.
Status: pending
Depends: task0104

### Project 2.8: Sites Meta-Package

#### task0107: Sites meta-package

File: `packages/sites/package.json`
Description: Create @vibeonrails/sites meta-package that re-exports all site packages. SKILL.md.
Status: pending
Depends: task0090, task0094, task0098, task0102, task0106

#### task0108: Sites CLI commands

File: `packages/cli/src/commands/sites.ts`
Description: Implement `npx vibe sites build`, `npx vibe sites serve`, `npx vibe sites list`.
Status: pending
Depends: task0107

#### task0109: Sites CLI tests

File: `packages/cli/src/commands/sites.test.ts`
Description: Test build, serve, list commands for all site types.
Status: pending
Depends: task0108

---

## Phase 3: Marketing & Content Machine

The autonomous content pipeline: heuristics, transformation, and channel posting.

### Project 3.1: Marketing Heuristics Engine

#### task0110: Marketing package scaffolding

File: `packages/ops/marketing/package.json`
Description: Initialize @vibeonrails/marketing. TypeScript config, Vitest, SKILL.md.
Status: pending

#### task0111: Heuristic types

File: `packages/ops/marketing/src/heuristics/types.ts`
Description: Define all 7 heuristic types (client, product, hook, story, concept, branding, CTA) with Zod schemas for frontmatter.
Status: pending
Depends: task0110

#### task0112: Heuristic loader

File: `packages/ops/marketing/src/heuristics/loader.ts`
Description: Load heuristics from content/marketing/heuristics/ using content index. Filter by type, validate frontmatter.
Status: pending
Depends: task0111, task0051

#### task0113: Heuristic loader tests

File: `packages/ops/marketing/src/heuristics/loader.test.ts`
Description: Test loading, filtering, validation, git hash tracking for generated content.
Status: pending
Depends: task0112

#### task0114: Heuristic CLI commands

File: `packages/ops/marketing/src/heuristics/cli.ts`
Description: Implement `npx vibe marketing heuristics list`, `npx vibe marketing heuristics create`.
Status: pending
Depends: task0112

#### task0115: Heuristic CLI tests

File: `packages/ops/marketing/src/heuristics/cli.test.ts`
Description: Test list by type, create from template, validation errors.
Status: pending
Depends: task0114

### Project 3.2: Marketing Transformation Engine

#### task0116: Transform types

File: `packages/ops/marketing/src/transform/types.ts`
Description: Define channel prompt format, transform input/output, generation config.
Status: pending
Depends: task0110

#### task0117: Transform engine

File: `packages/ops/marketing/src/transform/engine.ts`
Description: Read selected heuristics + channel prompt, call AI SDK, generate channel-specific content with frontmatter.
Status: pending
Depends: task0116, task0010, task0112

#### task0118: Transform engine tests

File: `packages/ops/marketing/src/transform/engine.test.ts`
Description: Test prompt assembly, AI fixture responses, output format validation, frontmatter generation with git hashes.
Status: pending
Depends: task0117

#### task0119: Transform CLI commands

File: `packages/ops/marketing/src/transform/cli.ts`
Description: Implement `npx vibe marketing generate <channel>` with all heuristic selection flags.
Status: pending
Depends: task0117

#### task0120: Transform CLI tests

File: `packages/ops/marketing/src/transform/cli.test.ts`
Description: Test generate command with flag combinations.
Status: pending
Depends: task0119

### Project 3.3: Marketing Channel Engine

#### task0121: Channel types

File: `packages/ops/marketing/src/channels/types.ts`
Description: Define Channel, PostResult, DraftMetadata, PostedMetadata types.
Status: pending
Depends: task0110

#### task0122: Channel engine

File: `packages/ops/marketing/src/channels/engine.ts`
Description: Post content via platform APIs (Twitter, Bluesky). Move files from drafts/ to posted/. Add metadata to frontmatter.
Status: pending
Depends: task0121, task0021, task0023

#### task0123: Channel engine tests

File: `packages/ops/marketing/src/channels/engine.test.ts`
Description: Test posting, file movement, metadata addition, autopilot mode, scheduling.
Status: pending
Depends: task0122

#### task0124: Channel CLI commands

File: `packages/ops/marketing/src/channels/cli.ts`
Description: Implement `npx vibe marketing post`, `npx vibe marketing autopilot`, `npx vibe marketing schedule`, `npx vibe marketing drafts`, `npx vibe marketing posted`, `npx vibe marketing stats`.
Status: pending
Depends: task0122

#### task0125: Channel CLI tests

File: `packages/ops/marketing/src/channels/cli.test.ts`
Description: Test all channel CLI commands.
Status: pending
Depends: task0124

#### task0126: Marketing barrel exports

File: `packages/ops/marketing/src/index.ts`
Description: Export all marketing sub-modules. Update package exports.
Status: pending
Depends: task0114, task0119, task0124

### Project 3.4: Connection Commands (vibe connect)

#### task0127: Connect CLI framework

File: `packages/cli/src/commands/connect.ts`
Description: Implement `npx vibe connect <provider>`, `npx vibe connections list`, `npx vibe disconnect <provider>`. OAuth browser flow.
Status: pending
Depends: task0015

#### task0128: Connect CLI tests

File: `packages/cli/src/commands/connect.test.ts`
Description: Test connect flow (mocked OAuth), list connections, disconnect cleanup.
Status: pending
Depends: task0127

---

## Phase 4: Support & Feedback

AI support widget, feedback-to-task pipeline, and multi-channel notifications.

### Project 4.1: Support Chat (@vibeonrails/support-chat)

#### task0129: Support chat package scaffolding

File: `packages/ops/support-chat/package.json`
Description: Initialize @vibeonrails/support-chat. SKILL.md.
Status: pending

#### task0130: Support chat types

File: `packages/ops/support-chat/src/types.ts`
Description: Define ChatMessage, ChatSession, SupportConfig, EscalationTicket types.
Status: pending
Depends: task0129

#### task0131: Support chat API endpoint

File: `packages/ops/support-chat/src/api.ts`
Description: POST /api/support/chat endpoint. SSE streaming for AI responses with automatic polling fallback (GET /api/support/chat/:sessionId/messages). Session management. Ticket creation on escalation.
Status: pending
Depends: task0130, task0010

#### task0132: Support chat API tests

File: `packages/ops/support-chat/src/api.test.ts`
Description: Test message handling, AI response streaming (fixtures), escalation trigger, ticket creation.
Status: pending
Depends: task0131

#### task0133: Support chat React widget

File: `packages/ops/support-chat/src/widget.tsx`
Description: Simple chat widget component. Text input, AI streaming display, "Talk to human" button, session persistence.
Status: pending
Depends: task0131

#### task0134: Support chat widget tests

File: `packages/ops/support-chat/src/widget.test.tsx`
Description: Test widget rendering, message sending, streaming display, escalation button.
Status: pending
Depends: task0133

#### task0135: Support chat database schema

File: `packages/ops/support-chat/src/schema.ts`
Description: Drizzle schema for chat_sessions and chat_messages tables.
Status: pending
Depends: task0130

#### task0136: Support chat barrel exports

File: `packages/ops/support-chat/src/index.ts`
Description: Export chat types, API, widget, schema.
Status: pending
Depends: task0131, task0133, task0135

### Project 4.2: Support Feedback (@vibeonrails/support-feedback)

#### task0137: Support feedback package scaffolding

File: `packages/ops/support-feedback/package.json`
Description: Initialize @vibeonrails/support-feedback. SKILL.md.
Status: pending

#### task0138: Feedback types

File: `packages/ops/support-feedback/src/types.ts`
Description: Define FeedbackInput, Classification (bug, feature-aligned, feature-unaligned, question, complaint), ClassificationResult.
Status: pending
Depends: task0137

#### task0139: Feedback classifier

File: `packages/ops/support-feedback/src/classifier.ts`
Description: AI classification against project context (.plan/ROADMAP.md, .plan/CONTEXT.md, existing tasks). Route to appropriate output.
Status: pending
Depends: task0138, task0010

#### task0140: Feedback classifier tests

File: `packages/ops/support-feedback/src/classifier.test.ts`
Description: Test classification with fixture AI responses. Test output routing for each category.
Status: pending
Depends: task0139

#### task0141: Feedback task generator

File: `packages/ops/support-feedback/src/generator.ts`
Description: Create .plan/tasks/backlog/bug-{slug}.md and feat-{slug}.md files. Append to requests.jsonl. Answer questions from knowledge base.
Status: pending
Depends: task0139

#### task0142: Feedback task generator tests

File: `packages/ops/support-feedback/src/generator.test.ts`
Description: Test file creation, JSONL appending, slug generation, deduplication.
Status: pending
Depends: task0141

#### task0143: Feedback CLI commands

File: `packages/ops/support-feedback/src/cli.ts`
Description: Implement `npx vibe support feedback summary`, `npx vibe support feedback export`.
Status: pending
Depends: task0141

#### task0144: Feedback barrel exports

File: `packages/ops/support-feedback/src/index.ts`
Description: Export feedback types, classifier, generator.
Status: pending
Depends: task0141, task0143

### Project 4.3: Notifications (@vibeonrails/notifications)

#### task0145: Notifications package scaffolding

File: `packages/ops/notifications/package.json`
Description: Initialize @vibeonrails/notifications. SKILL.md.
Status: pending

#### task0146: Notification types

File: `packages/ops/notifications/src/types.ts`
Description: Define NotificationChannel (email, in-app, push, discord), NotificationPreferences, DigestConfig, notification template types.
Status: pending
Depends: task0145

#### task0147: Notification dispatcher

File: `packages/ops/notifications/src/dispatcher.ts`
Description: Multi-channel dispatch. Check user preferences. Batch into digests. Markdown templates.
Status: pending
Depends: task0146

#### task0148: Notification dispatcher tests

File: `packages/ops/notifications/src/dispatcher.test.ts`
Description: Test multi-channel dispatch, preference filtering, digest batching, template rendering.
Status: pending
Depends: task0147

#### task0149: In-app notification storage

File: `packages/ops/notifications/src/storage.ts`
Description: Drizzle schema for notifications table. Mark as read. List unread. Frontend component for notification bell.
Status: pending
Depends: task0146

#### task0150: Notification barrel exports

File: `packages/ops/notifications/src/index.ts`
Description: Export notification types, dispatcher, storage.
Status: pending
Depends: task0147, task0149

---

## Phase 5: Business Operations (Sales + Finance)

CRM, financial reporting, and operations meta-packages.

### Project 5.1: Sales (@vibeonrails/sales)

#### task0151: Sales package scaffolding

File: `packages/ops/sales/package.json`
Description: Initialize @vibeonrails/sales. SKILL.md.
Status: pending

#### task0152: Sales types and schema

File: `packages/ops/sales/src/types.ts`
Description: Define Contact, Deal, ContactStage, DealStage, OutreachSequence types. Drizzle schemas.
Status: pending
Depends: task0151

#### task0153: Sales service

File: `packages/ops/sales/src/service.ts`
Description: CRUD for contacts and deals. CSV import. AI qualification via BANT. Stage management.
Status: pending
Depends: task0152

#### task0154: Sales service tests

File: `packages/ops/sales/src/service.test.ts`
Description: Test contact CRUD, deal management, CSV import, stage transitions.
Status: pending
Depends: task0153

#### task0155: Sales outreach

File: `packages/ops/sales/src/outreach.ts`
Description: Cold email sequences with personalization from marketing heuristics. Template-based.
Status: pending
Depends: task0153, task0112

#### task0156: Sales outreach tests

File: `packages/ops/sales/src/outreach.test.ts`
Description: Test sequence creation, personalization, sending schedule.
Status: pending
Depends: task0155

#### task0157: Sales CLI commands

File: `packages/ops/sales/src/cli.ts`
Description: Implement all `npx vibe sales` commands: contacts list/add/import, deals list/create, outreach create, report.
Status: pending
Depends: task0153, task0155

#### task0158: Sales CLI tests

File: `packages/ops/sales/src/cli.test.ts`
Description: Test all sales CLI commands.
Status: pending
Depends: task0157

#### task0159: Sales barrel exports

File: `packages/ops/sales/src/index.ts`
Description: Export sales types, service, outreach, schema.
Status: pending
Depends: task0153, task0155

### Project 5.2: Finance (@vibeonrails/finance)

#### task0160: Finance package scaffolding

File: `packages/ops/finance/package.json`
Description: Initialize @vibeonrails/finance. SKILL.md.
Status: pending

#### task0161: Finance types and interfaces

File: `packages/ops/finance/src/types.ts`
Description: Define RevenueSource, CostSource interfaces. FinanceReport, MRR, ChurnRate, LTV types. Invoice template types.
Status: pending
Depends: task0160

#### task0162: Stripe revenue source

File: `packages/ops/finance/src/sources/stripe.ts`
Description: Implement RevenueSource for Stripe. MRR calculation, churn rate, LTV, subscriber count.
Status: pending
Depends: task0161

#### task0163: Stripe revenue source tests

File: `packages/ops/finance/src/sources/stripe.test.ts`
Description: Test with HTTP fixture recordings. MRR calculation, churn, LTV accuracy.
Status: pending
Depends: task0162

#### task0164: Manual revenue/cost sources

File: `packages/ops/finance/src/sources/manual.ts`
Description: Implement RevenueSource and CostSource for JSONL files (income.jsonl, expenses.jsonl).
Status: pending
Depends: task0161

#### task0165: Manual sources tests

File: `packages/ops/finance/src/sources/manual.test.ts`
Description: Test JSONL reading, date filtering, aggregation.
Status: pending
Depends: task0164

#### task0166: Hosting cost source

File: `packages/ops/finance/src/sources/hosting.ts`
Description: Implement CostSource for Railway and Fly.io billing APIs.
Status: pending
Depends: task0161

#### task0167: Hosting cost source tests

File: `packages/ops/finance/src/sources/hosting.test.ts`
Description: Test with HTTP fixture recordings.
Status: pending
Depends: task0166

#### task0168: Finance report aggregator

File: `packages/ops/finance/src/report.ts`
Description: Aggregate all RevenueSource and CostSource data. Weekly/monthly reports. Profit calculation.
Status: pending
Depends: task0162, task0164, task0166

#### task0169: Finance report tests

File: `packages/ops/finance/src/report.test.ts`
Description: Test aggregation across multiple sources, report formatting, date range filtering.
Status: pending
Depends: task0168

#### task0170: Invoice generator

File: `packages/ops/finance/src/invoice.ts`
Description: Generate PDF invoices from markdown templates. Send via email (Resend).
Status: pending
Depends: task0161

#### task0171: Invoice generator tests

File: `packages/ops/finance/src/invoice.test.ts`
Description: Test PDF generation, template rendering, email sending (mocked).
Status: pending
Depends: task0170

#### task0172: Finance CLI commands

File: `packages/ops/finance/src/cli.ts`
Description: Implement all `npx vibe finance` commands: mrr, churn, ltv, expenses, report, invoice create.
Status: pending
Depends: task0168, task0170

#### task0173: Finance CLI tests

File: `packages/ops/finance/src/cli.test.ts`
Description: Test all finance CLI commands.
Status: pending
Depends: task0172

#### task0174: Finance barrel exports

File: `packages/ops/finance/src/index.ts`
Description: Export finance types, sources, report aggregator, invoice generator.
Status: pending
Depends: task0168, task0170

### Project 5.3: Ops Meta-Package

#### task0175: Ops meta-package

File: `packages/ops/package.json`
Description: Create @vibeonrails/ops meta-package re-exporting all ops sub-packages. SKILL.md.
Status: pending
Depends: task0126, task0136, task0144, task0150, task0159, task0174

---

## Phase 6: Companion, CLI Polish & Dogfooding

OpenClaw skills, smart module management, and self-hosting proof.

### Project 6.1: Companion (@vibeonrails/companion)

#### task0176: Companion package scaffolding

File: `packages/companion/package.json`
Description: Initialize @vibeonrails/companion. SKILL.md.
Status: pending

#### task0177: Core VoR project skill

File: `packages/companion/skills/vibe-project/skill.md`
Description: OpenClaw skill definition for running any VoR CLI command. Command patterns, safety rules, output formatting.
Status: pending
Depends: task0176

#### task0178: Marketing skill

File: `packages/companion/skills/vibe-marketing/skill.md`
Description: OpenClaw skill for marketing operations. Content generation, posting, autopilot, draft review.
Status: pending
Depends: task0176

#### task0179: Support skill

File: `packages/companion/skills/vibe-support/skill.md`
Description: OpenClaw skill for support operations. Ticket triage, feedback summary, escalation handling.
Status: pending
Depends: task0176

#### task0180: Finance skill

File: `packages/companion/skills/vibe-finance/skill.md`
Description: OpenClaw skill for finance operations. MRR reporting, cost tracking, invoice generation.
Status: pending
Depends: task0176

#### task0181: Analytics skill

File: `packages/companion/skills/vibe-analytics/skill.md`
Description: OpenClaw skill for analytics queries. Natural language to data.
Status: pending
Depends: task0176

#### task0182: Default personality template

File: `packages/companion/personality/agent.md`
Description: Default companion personality. Professional, helpful, concise. Copied to content/brand/agent.md during setup.
Status: pending
Depends: task0176

#### task0183: Companion setup CLI

File: `packages/companion/src/setup.ts`
Description: Implement `npx vibe companion setup discord`. Check OpenClaw, run compatibility check (min_openclaw_version + skill_format_version), install skills, configure channels, set personality, name companion, test connection.
Status: pending
Depends: task0177, task0178, task0179, task0180, task0181, task0182

#### task0184: Companion setup tests

File: `packages/companion/src/setup.test.ts`
Description: Test setup flow with mocked OpenClaw API. Skill installation, config, connection test.
Status: pending
Depends: task0183

#### task0185: Companion status and config CLI

File: `packages/companion/src/cli.ts`
Description: Implement `npx vibe companion status`, `npx vibe companion config`, `npx vibe companion logs`.
Status: pending
Depends: task0183

#### task0186: Companion barrel exports

File: `packages/companion/src/index.ts`
Description: Export companion setup and CLI commands.
Status: pending
Depends: task0183, task0185

### Project 6.2: CLI Module Management (vibe add / vibe remove)

#### task0187: Module registry

File: `packages/cli/src/modules/registry.ts`
Description: Define all available modules, their packages, file structures, route registrations, and dependencies.
Status: pending

#### task0188: Module registry tests

File: `packages/cli/src/modules/registry.test.ts`
Description: Test module lookup, dependency resolution, file manifest generation.
Status: pending
Depends: task0187

#### task0189: vibe add command

File: `packages/cli/src/commands/add.ts`
Description: Smart installer: install npm package, create directory structure, generate starter files, add routes, update config, show next steps. Write .vibe/modules.json manifest with file checksums for safe removal.
Status: pending
Depends: task0187

#### task0190: vibe add tests

File: `packages/cli/src/commands/add.test.ts`
Description: Test full add flow for each module type. Verify file creation, route registration, config update.
Status: pending
Depends: task0189

#### task0191: vibe remove command

File: `packages/cli/src/commands/remove.ts`
Description: Clean removal via .vibe/modules.json manifest. Delete unmodified files (checksum match), warn about modified files, remove deps and routes.
Status: pending
Depends: task0187

#### task0192: vibe remove tests

File: `packages/cli/src/commands/remove.test.ts`
Description: Test full remove flow. Verify file cleanup, dependency removal, route de-registration.
Status: pending
Depends: task0191

#### task0193: vibe modules list command

File: `packages/cli/src/commands/modules.ts`
Description: Show available modules, install status, descriptions.
Status: pending
Depends: task0187

#### task0194: Smart install flow update

File: `packages/cli/src/commands/create.ts`
Description: Update create-vibe with 2-question flow (template + modules). Template selection, module multi-select.
Status: pending
Depends: task0187

#### task0195: Smart install flow tests

File: `packages/cli/src/commands/create.test.ts`
Description: Test all 4 templates, module selection, post-install guidance output.
Status: pending
Depends: task0194

### Project 6.3: Dev Server (vibe dev) + HMR

#### task0223: Dev server orchestrator

File: `packages/cli/src/commands/dev.ts`
Description: Implement `vibe dev` with: single Vite instance in middleware mode (API + web in one process), lazy site servers (Astro starts on first request to /blog, /help, etc.), parallel initialization (env validation + content index + SKILL.md gen via Promise.all), boot time target <3s. Report boot timing.
Status: pending
Depends: task0215, task0209, task0217

#### task0224: Dev server orchestrator tests

File: `packages/cli/src/commands/dev.test.ts`
Description: Test boot sequence, lazy site loading, parallel init, boot time measurement, memory reporting.
Status: pending
Depends: task0223

#### task0225: HMR file watcher matrix

File: `packages/cli/src/dev/watcher.ts`
Description: Consolidated chokidar watcher for entire project. Route changes by file type: .ts → hot reload API, React → Vite HMR, Drizzle schema → detect + suggest `vibe db migrate`, content/\*.md → incremental site rebuild + content index update, vibe.config.ts → full restart with warning. SKILL.md regeneration on code changes (debounced 500ms).
Status: pending
Depends: task0223

#### task0226: HMR file watcher tests

File: `packages/cli/src/dev/watcher.test.ts`
Description: Test file type routing, schema change detection, content rebuild trigger, config restart warning, SKILL.md regen debounce.
Status: pending
Depends: task0225

#### task0227: Dev request timing middleware

File: `packages/core/src/api/middleware/timing.ts`
Description: Dev-only middleware that reports per-request timing breakdown: `[200 OK] POST /trpc/order.create 23ms (auth: 1ms, validate: 2ms, db: 18ms, serialize: 2ms)`. Highlight slow components (yellow >50ms, red >100ms). Disabled in production.
Status: pending

#### task0228: Dev request timing tests

File: `packages/core/src/api/middleware/timing.test.ts`
Description: Test timing capture, formatting, threshold highlighting, production disable.
Status: pending
Depends: task0227

### Project 6.4: Build Optimization (vibe build)

#### task0229: Parallel build orchestrator

File: `packages/cli/src/commands/build.ts`
Description: Implement `vibe build` with: parallel site builds (all Astro builds concurrent), incremental builds (only changed content), image optimization cache (.vibe/image-cache/ with content hash), esbuild for compilation + tsc for type checking in parallel. Report build timing breakdown. Target <30s.
Status: pending

#### task0230: Parallel build orchestrator tests

File: `packages/cli/src/commands/build.test.ts`
Description: Test parallel execution, incremental detection, image cache hits, timing report.
Status: pending
Depends: task0229

#### task0231: Image optimization cache

File: `packages/cli/src/build/image-cache.ts`
Description: Cache optimized images in .vibe/image-cache/ keyed by source content hash. WebP conversion, responsive srcset generation. Skip processing for cache hits. Report cache stats in build output.
Status: pending

#### task0232: Image optimization cache tests

File: `packages/cli/src/build/image-cache.test.ts`
Description: Test cache hit/miss, content hash comparison, WebP output, srcset generation, cache stats.
Status: pending
Depends: task0231

#### task0233: Markdown parse cache

File: `packages/cli/src/build/markdown-cache.ts`
Description: Cache parsed markdown ASTs in .vibe/markdown-cache/ keyed by content hash. Re-parse only changed files. Used by all Sites builds. Target: 500 pages <10s.
Status: pending

#### task0234: Markdown parse cache tests

File: `packages/cli/src/build/markdown-cache.test.ts`
Description: Test cache hit/miss, AST validity, incremental parsing, 500-file benchmark.
Status: pending
Depends: task0233

### Project 6.5: Deterministic Paths + Generated Code Conventions

#### task0235: Path convention documentation

File: `packages/core/src/conventions/paths.ts`
Description: Export a pathFor() utility that computes deterministic file paths from intent. pathFor('module', 'order', 'service') → 'src/modules/order/order.service.ts'. pathFor('heuristic', 'hook', 'pain') → 'content/marketing/heuristics/hooks/pain.md'. Used by CLI generators and AI agents.
Status: pending

#### task0236: Path convention tests

File: `packages/core/src/conventions/paths.test.ts`
Description: Test all path patterns: modules, content types, config, manifests. Ensure deterministic and predictable.
Status: pending
Depends: task0235

### Project 6.6: Dogfooding & Examples

#### task0196: Update basic example

File: `examples/basic/package.json`
Description: Update basic example to use V2 patterns. Add content index, analytics, security defaults.
Status: pending
Depends: task0054, task0064

#### task0197: Update SaaS example

File: `examples/saas/package.json`
Description: Update SaaS example with V2 modules: marketing, support, finance, sites.
Status: pending
Depends: task0175

#### task0198: Update app template

File: `templates/app/package.json`
Description: Update app template for V2 create-vibe flow. Include .plan/ directory, SKILL.md files, content/ structure.
Status: pending
Depends: task0194

#### task0199: Test utilities package

File: `packages/test-utils/package.json`
Description: Create shared test utilities: HTTP fixture recording, content fixture helpers, database test setup, mock factories.
Status: pending

#### task0200: Integration test suite

File: `__tests__/integration/full-stack.test.ts`
Description: Full-stack integration test: create project, generate module, run server, test API, build sites.
Status: pending
Depends: task0196, task0197, task0198

---

## Phase 7: Observability, Deployment & Data Safety

Production-readiness: structured logging, request tracing, deploy pipeline, migration safety.

### Project 7.1: Structured Logging & Request Tracing

#### task0237: Structured logger (pino)

File: `packages/infra/src/logging/logger.ts`
Description: Implement structured JSON logger via pino. Every log: request_id, timestamp, level, module, message, context. pino-pretty in dev (human-readable), raw JSON in production. Logs to stdout (12-factor).
Status: pending

#### task0238: Structured logger tests

File: `packages/infra/src/logging/logger.test.ts`
Description: Test JSON output format, request_id propagation, level filtering, dev vs prod formatting.
Status: pending
Depends: task0237

#### task0239: Request tracing middleware

File: `packages/core/src/api/middleware/tracing.ts`
Description: Assign unique x-request-id to every HTTP request. Propagate through DB queries, external API calls (integrations SDK), AI SDK calls, queue jobs. Full lifecycle traceable from one ID.
Status: pending
Depends: task0237

#### task0240: Request tracing tests

File: `packages/core/src/api/middleware/tracing.test.ts`
Description: Test ID generation, header propagation, cross-service trace, DB query tagging.
Status: pending
Depends: task0239

#### task0241: AI call logging

File: `packages/ai/src/logging.ts`
Description: Log every AI SDK call: prompt tokens, completion tokens, duration, model, provider, cost estimate. Dev mode: full prompt/response to .vibe/ai-logs/. Production: metadata only.
Status: pending
Depends: task0237, task0010

#### task0242: AI call logging tests

File: `packages/ai/src/logging.test.ts`
Description: Test metadata logging, cost estimation, dev-mode full logging, production metadata-only.
Status: pending
Depends: task0241

### Project 7.2: Dev Query Analyzer

#### task0243: N+1 detector and slow query warner

File: `packages/core/src/database/analyzer.ts`
Description: Dev-only query analyzer. Log every query with duration. Warn >100ms with EXPLAIN ANALYZE output. Detect N+1 (same query >3x in one request). Suggest exact CREATE INDEX statement. Zero overhead in production.
Status: pending
Depends: task0239

#### task0244: Query analyzer tests

File: `packages/core/src/database/analyzer.test.ts`
Description: Test slow query detection, N+1 detection, index suggestion generation, production disable.
Status: pending
Depends: task0243

### Project 7.3: OAuth Debugging & Connection Status

#### task0245: Connection status command

File: `packages/cli/src/commands/connections-status.ts`
Description: `vibe connections status` shows: token expiry, last refresh time, last error, provider health. Failed refreshes logged with full context. Auto-retry with exponential backoff.
Status: pending
Depends: task0015

#### task0246: Connection status tests

File: `packages/cli/src/commands/connections-status.test.ts`
Description: Test status display, error reporting, expiry warning, refresh failure context.
Status: pending
Depends: task0245

### Project 7.4: Production Error Reporting

#### task0247: Error reporter with context

File: `packages/core/src/errors/reporter.ts`
Description: Production errors include: error code (catalog), request_id, user_id, stack trace, auto_fixable hint. Errors batched in memory. `vibe errors --last 24h` queries production error log.
Status: pending
Depends: task0201, task0239

#### task0248: Error reporter tests

File: `packages/core/src/errors/reporter.test.ts`
Description: Test error batching, context enrichment, query by time range, JSON output format.
Status: pending
Depends: task0247

### Project 7.5: Deploy Pipeline

#### task0249: Deploy command with platform detection

File: `packages/cli/src/commands/deploy.ts`
Description: `vibe deploy` auto-detects platform (Railway via RAILWAY_TOKEN, Fly.io via FLY_ACCESS_TOKEN, Docker via Dockerfile). Runs: env validation → build → migrate (additive only) → deploy → health check gate (wait for /health 200, 30s timeout). Abort on failure.
Status: pending
Depends: task0215

#### task0250: Deploy command tests

File: `packages/cli/src/commands/deploy.test.ts`
Description: Test platform detection, env validation pre-deploy, migration safety (additive vs destructive), health check gate, abort on failure.
Status: pending
Depends: task0249

#### task0251: Static/API split deploy

File: `packages/cli/src/commands/deploy-split.ts`
Description: `vibe deploy --sites-only` pushes SSG output to CDN. `vibe deploy --api-only` deploys server. Full deploy does both. Sites get immutable cache headers, API gets health check gate.
Status: pending
Depends: task0249

#### task0252: Split deploy tests

File: `packages/cli/src/commands/deploy-split.test.ts`
Description: Test sites-only deploy, api-only deploy, full deploy, CDN cache header verification.
Status: pending
Depends: task0251

### Project 7.6: Migration Safety

#### task0253: Auto-generated migrations from schema diff

File: `packages/cli/src/commands/db-migrate-create.ts`
Description: `vibe db migrate create` diffs current Drizzle schema vs database, auto-generates SQL migration. Shows SQL, asks confirmation. Generates both up() and down(). Flags destructive operations (drop, rename) requiring --destructive.
Status: pending

#### task0254: Migration create tests

File: `packages/cli/src/commands/db-migrate-create.test.ts`
Description: Test additive migration gen (add column/table/index), destructive detection, up/down generation, confirmation flow.
Status: pending
Depends: task0253

#### task0255: Migration dry-run and rollback

File: `packages/cli/src/commands/db-migrate-ops.ts`
Description: `vibe db migrate --dry-run` shows SQL without executing. `vibe db rollback` runs last migration's down(). `vibe db rollback --to <version>` multi-step rollback. Always shows SQL before executing.
Status: pending
Depends: task0253

#### task0256: Migration ops tests

File: `packages/cli/src/commands/db-migrate-ops.test.ts`
Description: Test dry-run output, single rollback, multi-step rollback, round-trip (up → down → up).
Status: pending
Depends: task0255

#### task0257: Per-environment seeds

File: `packages/cli/src/commands/db-seed-env.ts`
Description: `vibe db seed` reads from database/seeds/{env}.ts. Dev: 50 users, 200 posts (rich fake data). Staging: minimal. Production: system records only. Env auto-detected from NODE_ENV.
Status: pending

#### task0258: Per-environment seed tests

File: `packages/cli/src/commands/db-seed-env.test.ts`
Description: Test dev seed richness, staging minimality, production system-only, env detection.
Status: pending
Depends: task0257

#### task0259: Database snapshots

File: `packages/cli/src/commands/db-snapshot.ts`
Description: `vibe db snapshot create <name>` saves current DB state. `vibe db snapshot restore <name>` restores it. Stored in .vibe/snapshots/ (pg_dump). Instant rollback during development.
Status: pending

#### task0260: Database snapshot tests

File: `packages/cli/src/commands/db-snapshot.test.ts`
Description: Test create, restore, list, delete snapshots. Verify data integrity after restore.
Status: pending
Depends: task0259

---

## Phase 8: Ecosystem & Testing DX

Extensibility patterns, community modules, and testing infrastructure.

### Project 8.1: Custom Integrations & CLI Plugins

#### task0261: defineCommand() for custom CLI plugins

File: `packages/cli/src/plugins/define-command.ts`
Description: `defineCommand()` helper for user-created CLI commands in `src/commands/`. Auto-registered by vibe CLI. Gets output formatting (VIBE_OUTPUT), error catalog, and --json for free.
Status: done
Depends: task0213

#### task0262: defineCommand tests

File: `packages/cli/src/plugins/define-command.test.ts`
Description: Test command registration, output formatting inheritance, error catalog integration, auto-discovery from src/commands/.
Status: done
Depends: task0261

#### task0263: Community module publishing

File: `packages/cli/src/commands/modules-publish.ts`
Description: `vibe modules publish` packages a module for npm following VoR conventions (SKILL.md, barrel exports, types). Validates structure before publish. `vibe modules list --community` discovers community modules.
Status: done
Depends: task0187

#### task0264: Community module tests

File: `packages/cli/src/commands/modules-publish.test.ts`
Description: Test publish validation (SKILL.md required, barrel exports, types), package structure, community listing.
Status: done
Depends: task0263

### Project 8.2: Test Factories & Isolation

#### task0265: Test factory helpers

File: `packages/test-utils/src/factories.ts`
Description: Ship factory helpers: createUser(), createPost(), createOrder(), createContact(), createDeal(). Realistic fake data with overrides. Auto-detect installed modules and generate appropriate data.
Status: done
Depends: task0199

#### task0266: Test factory tests

File: `packages/test-utils/src/factories.test.ts`
Description: Test data generation, override merging, module detection, type safety.
Status: done
Depends: task0265

#### task0267: Transaction isolation per test

File: `packages/test-utils/src/isolation.ts`
Description: Every integration test runs inside a DB transaction that rolls back after test. No data leaks. No cleanup needed. Helper: `withTestTransaction(async (db) => { ... })`.
Status: done
Depends: task0199

#### task0268: Transaction isolation tests

File: `packages/test-utils/src/isolation.test.ts`
Description: Test rollback after success, rollback after failure, no data persistence between tests, nested transaction support.
Status: done
Depends: task0267

### Project 8.3: Fixture Recording & Coverage

#### task0269: HTTP fixture recording CLI

File: `packages/cli/src/commands/test-record.ts`
Description: `vibe test record <test-file>` runs test with LIVE_API=true, records all HTTP interactions to **tests**/fixtures/. Replay in CI. `vibe test record --update` re-records stale fixtures.
Status: pending
Depends: task0199

#### task0270: Fixture recording tests

File: `packages/cli/src/commands/test-record.test.ts`
Description: Test recording, replay, staleness detection, update flow.
Status: pending
Depends: task0269

#### task0271: Per-package coverage reporting

File: `packages/cli/src/commands/test-coverage.ts`
Description: `vibe test --coverage` reports coverage per package. Fails build if any package <80%. Shows uncovered files. Generates coverage badge per package README.
Status: pending

#### task0272: Coverage reporting tests

File: `packages/cli/src/commands/test-coverage.test.ts`
Description: Test per-package aggregation, threshold enforcement, badge generation, uncovered file listing.
Status: pending
Depends: task0271

---

## Phase 9: WOW Factor — Zero-to-Revenue & Companion

The "holy shit" features. Working payments from scratch, x402 protocol, and companion magic.

### Project 9.1: 60-Second Payments (SaaS Template)

#### task0273: Pre-wired Stripe checkout in SaaS template

File: `templates/app/src/modules/payments/checkout.ts`
Description: SaaS template ships with working Stripe checkout. Add STRIPE_SECRET_KEY → visit /pricing → working payment. Subscription management, customer portal, webhook handling pre-wired. Zero code for basic payments.
Status: pending

#### task0274: Stripe checkout tests

File: `templates/app/src/modules/payments/checkout.test.ts`
Description: Test checkout flow with HTTP fixtures, subscription creation, webhook handling, customer portal redirect.
Status: pending
Depends: task0273

#### task0275: PricingTable component

File: `packages/web/src/components/pricing/pricing-table.tsx`
Description: `<PricingTable />` reads plans from content/pricing/plans.md. Renders pricing cards with plan name, price, features, CTA button. Stripe checkout pre-connected to each button.
Status: pending
Depends: task0273

#### task0276: PricingTable tests

File: `packages/web/src/components/pricing/pricing-table.test.tsx`
Description: Test plan rendering from markdown, Stripe checkout connection, responsive layout, accessibility.
Status: pending
Depends: task0275

#### task0277: Pre-built onboarding flow

File: `templates/app/src/web/pages/onboarding.tsx`
Description: SaaS template includes: landing page → signup → select plan → pay → dashboard. Every step works out of the box. First customer can pay before user writes business logic.
Status: pending
Depends: task0275

#### task0278: Onboarding flow tests

File: `templates/app/src/web/pages/onboarding.test.tsx`
Description: Test full onboarding flow: signup, plan selection, checkout redirect, dashboard access after payment.
Status: pending
Depends: task0277

### Project 9.2: x402 Pay-Per-API-Call

#### task0279: x402 protocol implementation

File: `packages/core/src/x402/protocol.ts`
Description: x402 HTTP payment protocol. `paidProcedure.price('$0.01')` marks any tRPC route as paid. Client sends payment in HTTP header (L402/x402). USDC stablecoin settlement. Revenue tracked in finance module.
Status: pending

#### task0280: x402 protocol tests

File: `packages/core/src/x402/protocol.test.ts`
Description: Test payment header parsing, price validation, settlement flow (mocked), revenue tracking, missing payment response (402).
Status: pending
Depends: task0279

#### task0281: x402 middleware

File: `packages/core/src/x402/middleware.ts`
Description: Hono middleware that intercepts paid routes. Validates payment header. Settles payment. Passes request through on success. Returns 402 Payment Required on failure with payment instructions.
Status: pending
Depends: task0279

#### task0282: x402 middleware tests

File: `packages/core/src/x402/middleware.test.ts`
Description: Test payment validation, 402 response format, settlement success/failure, rate tracking.
Status: pending
Depends: task0281

#### task0283: x402 companion skill

File: `packages/companion/skills/vibe-x402/skill.md`
Description: OpenClaw skill for x402 revenue monitoring. Companion reports daily x402 revenue, top-earning endpoints, payment failures.
Status: pending
Depends: task0279

### Project 9.3: Companion Setup Magic

#### task0284: One-command OpenClaw provisioning

File: `packages/companion/src/provision.ts`
Description: `vibe companion setup` detects existing OpenClaw. If none: (A) Deploy to Railway (one-click template, ~60s), (B) Docker compose locally, (C) Connect existing. Option A auto-provisions VPS with OpenClaw + VoR skills.
Status: pending
Depends: task0183

#### task0285: OpenClaw provisioning tests

File: `packages/companion/src/provision.test.ts`
Description: Test detection flow, Railway template deployment (mocked), Docker compose generation, existing instance connection.
Status: pending
Depends: task0284

#### task0286: Companion first impression

File: `packages/companion/src/first-run.ts`
Description: After setup, companion introduces itself in Discord with name, capabilities, and example commands. "Hey! I'm [name]. Try: 'what's my MRR?' or 'generate a tweet about [topic]'."
Status: pending
Depends: task0284

#### task0287: Multi-project companion support

File: `packages/companion/src/multi-project.ts`
Description: One OpenClaw instance serves multiple VoR projects. Project-specific skills installed per project. Context switching based on Discord channel or explicit project name.
Status: pending
Depends: task0284

#### task0288: Companion periodic tasks

File: `packages/companion/skills/vibe-periodic/skill.md`
Description: Companion skill for scheduled tasks: weekly finance report (Monday), daily content generation (weekday), support summary (Friday). Configurable via content/brand/agent.md.
Status: pending
Depends: task0284

---

## Phase 10: WOW Factor — Time Travel, Dashboards & AI Superpowers

Undo system, live dashboards, AI-powered generation, and one-sentence landing pages.

### Project 10.1: Undo System

#### task0289: Undo stack

File: `packages/cli/src/undo/stack.ts`
Description: `vibe undo` reverts last CLI operation. Undo stack (.vibe/undo-stack.json) stores last 10 operations with reverse actions. `vibe add marketing` → `vibe undo` removes it. `vibe generate module order` → `vibe undo` deletes files.
Status: pending

#### task0290: Undo stack tests

File: `packages/cli/src/undo/stack.test.ts`
Description: Test undo for add, remove, generate operations. Test stack depth limit (10). Test undo of undo.
Status: done
Depends: task0289

#### task0291: Content version history

File: `packages/cli/src/commands/content-history.ts`
Description: `vibe content history <file>` shows git log with diffs. `vibe content restore <file> <commit>` restores previous version. AI can compare: "This hook performed 2x better before last edit."
Status: done

#### task0292: Content history tests

File: `packages/cli/src/commands/content-history.test.ts`
Description: Test git log parsing, diff display, restore operation, version comparison.
Status: pending
Depends: task0291

#### task0293: Config diff

File: `packages/cli/src/commands/config-diff.ts`
Description: `vibe config diff` shows vibe.config.ts changes since last deploy. Highlights security-relevant changes. Prevents accidental config changes reaching production.
Status: done

#### task0294: Config diff tests

File: `packages/cli/src/commands/config-diff.test.ts`
Description: Test diff detection, security change highlighting, deploy marker tracking.
Status: done
Depends: task0293

### Project 10.2: Live Dashboards

#### task0295: `vibe status` business dashboard

File: `packages/cli/src/commands/status.ts`
Description: One-command business dashboard: MRR, active users, pageviews (24h), open tickets, content pipeline (drafts/posted), API health, build status, deploy version. Beautiful terminal output + JSON mode.
Status: done
Depends: task0213

#### task0296: Status command tests

File: `packages/cli/src/commands/status.test.ts`
Description: Test data aggregation from all sources, terminal rendering, JSON output, missing module handling.
Status: done
Depends: task0295

#### task0297: Dev welcome page

File: `packages/web/src/components/welcome/welcome-page.tsx`
Description: `vibe dev` serves welcome page at / (before user adds routes): project name, installed modules, quick links (sites, API explorer, Drizzle Studio, health). First thing user sees works.
Status: done

#### task0298: Welcome page tests

File: `packages/web/src/components/welcome/welcome-page.test.tsx`
Description: Test module listing, link generation, health display, responsive layout.
Status: done
Depends: task0297

#### task0299: `vibe report` AI weekly summary

File: `packages/cli/src/commands/report.ts`
Description: AI-generated weekly business report. Reads: analytics, finance, support, marketing data. Generates 1-page markdown summary. Companion posts to #general every Monday. `vibe report --weekly` runs on demand.
Status: done
Depends: task0010, task0213

#### task0300: Report command tests

File: `packages/cli/src/commands/report.test.ts`
Description: Test data aggregation, AI summary generation (fixtures), markdown output, companion posting.
Status: done
Depends: task0299

### Project 10.3: AI-Native Superpowers

#### task0301: `vibe ask` natural language interface

File: `packages/cli/src/commands/ask.ts`
Description: "How do I add payments?" → reads SKILL.md + project.json + installed modules → answers with exact steps for THIS project. Context-aware, not generic docs. Uses AI SDK.
Status: done
Depends: task0010, task0209

#### task0302: `vibe ask` tests

File: `packages/cli/src/commands/ask.test.ts`
Description: Test context loading (SKILL.md, project.json), AI response generation (fixtures), project-specific answers.
Status: done
Depends: task0301

#### task0303: `vibe fix` auto-fixer

File: `packages/cli/src/commands/fix.ts`
Description: Scans project for all errors (type errors, missing env vars, broken configs). Auto-fixes everything marked auto_fixable in error catalog. Reports what was fixed and what needs human decision.
Status: pending
Depends: task0201, task0215

#### task0304: `vibe fix` tests

File: `packages/cli/src/commands/fix.test.ts`
Description: Test auto-fix application, human-decision-needed reporting, fix verification, no false fixes.
Status: done
Depends: task0303

#### task0305: AI module generation from description

File: `packages/cli/src/commands/generate-ai.ts`
Description: `vibe generate module order --describe "e-commerce orders with Stripe checkout, inventory, email confirmations"` → AI generates full module: Zod schemas, service (business logic), controller (tRPC), tests. One sentence → working module.
Status: done
Depends: task0010, task0219

#### task0306: AI module generation tests

File: `packages/cli/src/commands/generate-ai.test.ts`
Description: Test generation from description (fixtures), output validation (types, service, controller, tests all valid), VOR: comments presence.
Status: done
Depends: task0305

#### task0307: One-sentence landing page

File: `packages/sites/landing/src/ai-generator.ts`
Description: User writes `description: "AI-powered project management for remote teams"` in vibe.config.ts. `vibe sites build` generates complete landing page: hero, features grid, pricing, CTA. AI reads branding heuristic + product heuristic.
Status: done
Depends: task0010, task0096

#### task0308: One-sentence landing page tests

File: `packages/sites/landing/src/ai-generator.test.ts`
Description: Test generation from description (fixtures), section completeness (hero, features, pricing, CTA), heuristic consumption, HTML output.
Status: done
Depends: task0307

#### task0309: Predictive error prevention

File: `packages/cli/src/dev/prevention.ts`
Description: Dev mode file watcher analyzes code on save. Detects: missing Zod validation on user input, unhandled errors, missing auth on new routes, SQL injection patterns. Warns BEFORE code runs. Real-time security + correctness linter.
Status: pending
Depends: task0225, task0201

#### task0310: Predictive prevention tests

File: `packages/cli/src/dev/prevention.test.ts`
Description: Test detection of missing validation, missing auth, unsafe SQL patterns, warning output format.
Status: pending
Depends: task0309

---

## Dependencies

- **Astro** — SSG engine for Sites family (deep wrap, user never sees it)
- **better-sqlite3** — Build-time content index (CLI/build only, not runtime)
- **Anthropic SDK** — Default AI provider
- **OpenAI SDK** — Alternative AI provider
- **Ollama** — Local AI provider (no npm dependency, HTTP API)
- **Polly.js** or equivalent — HTTP fixture recording for tests
- **chokidar** — Consolidated file watcher for dev server
- **tsx** — esbuild-based TypeScript execution for dev mode (<3s boot)
- **sharp** — Image optimization with caching for Sites builds
- **pino** + **pino-pretty** — Structured JSON logging
- **x402 SDK** — HTTP payment protocol for pay-per-API-call
- **pg_dump** — Database snapshots (system dependency)

## Risks

- **Risk**: Astro integration complexity may require deep knowledge of Astro internals | **Mitigation**: Start with simplest Astro integration, iterate. Astro has good integration docs.
- **Risk**: OpenClaw API stability for companion skills | **Mitigation**: Skills are markdown files (simple), setup CLI is the only code touching OpenClaw API. Canary CI tests against latest OpenClaw.
- **Risk**: AI fixture recordings may drift from real API behavior | **Mitigation**: Monthly live test run (LIVE_AI_TESTS=true) in CI to catch API contract changes.
- **Risk**: 310 tasks is a large scope | **Mitigation**: Each phase is independently shippable. Release after each phase. Agentic coding with free credits.
- **Risk**: Single vibe.config.ts could become bloated | **Mitigation**: Config schema is typed with autocomplete. Sections are optional. Defaults cover 90% of use cases.
- **Risk**: x402 protocol maturity — still early | **Mitigation**: Ship as experimental flag. Users opt-in via vibe.config.ts. Can be disabled entirely.
- **Risk**: AI-generated modules may produce low-quality code | **Mitigation**: AI output goes through the same validation (types, lint, test). Human review required. Generated code includes // VOR: comments for easy editing.

## Notes

- Each task maps to exactly ONE file change
- TDD workflow: write tests first (RED), implement (GREEN), refactor (IMPROVE)
- Each phase is tagged as a release (v2.0-alpha.1 through v2.0-alpha.10)
- Phases can overlap: Phase 2 can start while Phase 1 is in polish
- All packages must have auto-generated SKILL.md before being considered complete
- All CLI commands must support VIBE_OUTPUT=json for AI agent consumption
- All errors must be registered in the error catalog (no ad-hoc errors)
- All generated code must include // VOR: comments for AI guidance
- .vibe/project.json must be updated after every structural change
- Performance targets: dev boot <3s, build <30s, API P99 <50ms, SSG 500pg <10s, bundle <50KB gz
- WOW targets: payments working in 60s, companion setup in 60s, `vibe status` shows full business in 1 command

## Task Status Legend

- **pending** — Not started
- **in-progress** — Currently being worked on
- **completed** — Done and verified
- **blocked** — Waiting on dependency or decision
